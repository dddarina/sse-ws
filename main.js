(()=>{"use strict";class e{constructor(e="https://sse-nq1x22rx8-dddarinas-projects.vercel.app"){this.baseURL=e}list(){throw new Error('Method "list" must be implemented')}get(){throw new Error('Method "get" must be implemented')}create(){throw new Error('Method "create" must be implemented')}update(){throw new Error('Method "update" must be implemented')}delete(){throw new Error('Method "delete" must be implemented')}}const t=async(e={})=>{const{url:t,method:s,data:i}=e;try{const e=await fetch(t,{method:s||"POST",headers:{"Content-Type":"application/json"},body:i?JSON.stringify(i):null}),n=await e.json();if(!e.ok){const t=new Error(n.message||`HTTP error! status: ${e.status}`);throw t.status=e.status,t}return n}catch(e){throw console.error("Request error:",e),e}};class s extends e{async create(e){return t({url:`${this.baseURL}/new-user`,method:"POST",data:e})}}class i{constructor(e){this.container=e,this.notifications=new Set}show(e,t="info"){const s=this.createNotification(e,t);this.container.append(s),this.notifications.add(s);const i=setTimeout((()=>{this.remove(s)}),5e3);this.setupEventListeners(s,i)}createNotification(e,t){const s=document.createElement("div");return s.className=`notification notification-${t}`,s.innerHTML=`\n      <div class="notification-content">\n        <span class="notification-message">${this.escapeHtml(e)}</span>\n        <button class="notification-close">√ó</button>\n      </div>\n    `,s}setupEventListeners(e,t){const s=e.querySelector(".notification-close");s&&s.addEventListener("click",(()=>{clearTimeout(t),this.remove(e)})),e.addEventListener("click",(s=>{s.target===e&&(clearTimeout(t),this.remove(e))}))}remove(e){e&&this.notifications.has(e)&&(e.classList.add("notification-hiding"),setTimeout((()=>{e.remove(),this.notifications.delete(e)}),300))}clearAll(){this.notifications.forEach((e=>{e.remove()})),this.notifications.clear()}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}const n=document.getElementById("root");new class{constructor(e){this.container=e,this.api=new s,this.websocket=null,this.currentUser=null,this.users=[],this.isConnecting=!1,this.autoReconnect=!0,this.isExiting=!1,this.messageHistory=[],this.reconnectionAttempts=0,this.maxReconnectionAttempts=10,this.errorTimer=null,this.heartbeatInterval=null,this.heartbeatTimeout=null,this.lastPongTime=null,this.notificationManager=null}init(){this.bindToDOM(),this.registerEvents(),this.checkAndCleanStuckUsers().then((()=>{this.showAuthModal()})),window.addEventListener("beforeunload",(()=>{this.exitOnUnload()})),document.addEventListener("visibilitychange",(()=>{document.hidden?console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ —Ñ–æ–Ω–µ, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ..."):this.websocket&&this.websocket.readyState!==WebSocket.OPEN&&(console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–∫—Ç–∏–≤–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ..."),this.reconnectIfNeeded())}))}bindToDOM(){this.authModal=document.createElement("div"),this.authModal.className="modal__form",this.authModal.innerHTML='\n      <div class="modal__background"></div>\n      <div class="modal__content">\n        <div class="modal__header">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç!</div>\n        <div class="modal__body">\n          <form class="auth-form">\n            <div class="form__group">\n              <label class="form__label">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º:</label>\n              <input type="text" class="form__input auth-input" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" required>\n              <div class="form__hint">–û—Ç 2 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤</div>\n            </div>\n            <div class="form__hint error-message" style="display: none;"></div>\n          </form>\n        </div>\n        <div class="modal__footer">\n          <div class="modal__ok auth-button">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É</div>\n        </div>\n      </div>\n    ',this.chatContainer=document.createElement("div"),this.chatContainer.className="container hidden",this.chatContainer.innerHTML='\n      <div class="chat-header-container">\n        <h1 class="chat__header">–ß–∞—Ç –¥–ª—è –¥—Ä—É–∑–µ–π</h1>\n        <div class="user-info">\n          <span class="current-username"></span>\n          <div class="chat__connect exit-button">–í—ã–π—Ç–∏</div>\n        </div>\n      </div>\n      \n      <div class="connection-status hidden">\n        <div class="form__hint status-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>\n      </div>\n      \n      \x3c!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π --\x3e\n      <div class="notifications-container"></div>\n      \n      <div class="chat__container">\n        <div class="chat__area">\n          <div class="chat__messages-container">\n            <div class="welcome-message">\n              <h3>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç!</h3>\n              <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ø—Ä–∞–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ.</p>\n            </div>\n            <ul class="messages-list"></ul>\n          </div>\n          <div class="chat__messages-input">\n            <form class="form message-form">\n              <div class="form__group form_second">\n                <textarea class="form__input message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" disabled rows="1"></textarea>\n                <button type="submit" class="send-button" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>\n              </div>\n            </form>\n          </div>\n        </div>\n        \n        <div class="chat__userlist">\n          <div class="users-header">\n            <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏ (<span class="users-count">0</span>)</h3>\n            <button class="refresh-users" title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫">üîÑ</button>\n          </div>\n          <ul class="users-list">\n            <li class="no-users">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç</li>\n          </ul>\n        </div>\n      </div>\n    ',this.confirmModal=document.createElement("div"),this.confirmModal.className="modal__delete hidden",this.confirmModal.innerHTML='\n      <div class="modal__background"></div>\n      <div class="modal__content">\n        <div class="modal__header">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞</div>\n        <div class="modal__body">\n          <div class="modal-text">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ —á–∞—Ç–∞?</div>\n        </div>\n        <div class="modal__footer">\n          <div class="modal__close cancel-button">–û—Å—Ç–∞—Ç—å—Å—è</div>\n          <div class="modal__ok confirm-exit-button">–í—ã–π—Ç–∏</div>\n        </div>\n      </div>\n    ',this.container.append(this.authModal,this.chatContainer,this.confirmModal);const e=this.chatContainer.querySelector(".notifications-container");this.notificationManager=new i(e)}registerEvents(){this.authModal.querySelector(".auth-button").addEventListener("click",(e=>{e.preventDefault(),this.onEnterChatHandler(e)})),this.authModal.querySelector(".auth-form").addEventListener("submit",(e=>{e.preventDefault(),this.onEnterChatHandler(e)})),this.authModal.querySelector(".auth-input").addEventListener("input",(()=>{this.hideError()})),this.messageForm=this.chatContainer.querySelector(".message-form"),this.messageForm.addEventListener("submit",(e=>{e.preventDefault(),this.sendMessage()})),this.chatContainer.querySelector(".exit-button").addEventListener("click",(()=>{this.showExitConfirmation()})),this.chatContainer.querySelector(".refresh-users").addEventListener("click",(()=>{this.refreshUsersList()})),this.confirmModal.querySelector(".cancel-button").addEventListener("click",(()=>{this.hideExitConfirmation()})),this.confirmModal.querySelector(".confirm-exit-button").addEventListener("click",(()=>{this.performExit()})),this.messageInput=this.chatContainer.querySelector(".message-input"),this.messageInput.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())})),this.messageInput.addEventListener("input",(()=>{this.messageInput.style.height="auto",this.messageInput.style.height=Math.min(this.messageInput.scrollHeight,150)+"px"}))}startHeartbeat(){this.stopHeartbeat(),console.log("Heartbeat –∑–∞–ø—É—â–µ–Ω"),this.heartbeatInterval=setInterval((()=>{if(this.websocket&&this.websocket.readyState===WebSocket.OPEN)try{this.websocket.send(JSON.stringify({type:"ping"})),console.log("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω ping")}catch(e){console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ping:",e)}}),15e3),this.lastPongTime=Date.now()}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null),this.heartbeatTimeout&&(clearTimeout(this.heartbeatTimeout),this.heartbeatTimeout=null),console.log("Heartbeat –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")}refreshUsersList(){this.websocket&&this.websocket.readyState===WebSocket.OPEN?(this.websocket.send(JSON.stringify({type:"get_users"})),this.showNotification("–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω","info")):this.showNotification("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º","error")}reconnectIfNeeded(){this.currentUser&&!this.isExiting&&(this.websocket&&this.websocket.readyState===WebSocket.OPEN||(console.log("–ü—Ä–æ–≤–µ—Ä–∫–∞: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ, –ø—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è..."),this.connectWebSocket()))}async checkAndCleanStuckUsers(){const e=localStorage.getItem("last_chat_username"),t=localStorage.getItem("last_chat_session_time");if(e&&t){Date.now()-parseInt(t)>3e5&&(console.log(`–û–±–Ω–∞—Ä—É–∂–µ–Ω "–∑–∞–≤–∏—Å—à–∏–π" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${e}", —É–¥–∞–ª—è–µ–º...`),await this.removeStuckUser(e))}localStorage.setItem("last_chat_session_time",Date.now().toString())}async removeStuckUser(e){try{const t=await fetch("http://localhost:3000/force-remove-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);if("ok"===(await t.json()).status)return console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${e}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞`),localStorage.removeItem("last_chat_username"),localStorage.removeItem("last_chat_session_time"),!0}catch(e){console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ "–∑–∞–≤–∏—Å—à–µ–≥–æ" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:',e)}return!1}subscribeOnEvents(){this.websocket&&(this.websocket.onopen=()=>{if(console.log("WebSocket connection established"),this.updateConnectionStatus("connected","–ü–æ–¥–∫–ª—é—á–µ–Ω–æ"),this.enableMessageInput(),this.autoReconnect=!0,this.reconnectionAttempts=0,this.showNotification("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —á–∞—Ç—É","success"),this.startHeartbeat(),this.currentUser){const e={type:"join",user:this.currentUser};this.websocket.send(JSON.stringify(e))}this.updateUserInfo(),this.websocket.readyState===WebSocket.OPEN&&this.websocket.send(JSON.stringify({type:"get_users"}))},this.websocket.onmessage=e=>{try{const t=JSON.parse(e.data);if(console.log("–ü–æ–ª—É—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:",t),"pong"===t.type)return this.lastPongTime=Date.now(),void console.log("–ü–æ–ª—É—á–µ–Ω pong –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");if(Array.isArray(t))this.updateUsersList(t);else if(t&&"object"==typeof t)switch(t.type){case"send":this.renderMessage(t);break;case"user_joined":this.showSystemMessage(`${t.user.name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É`),this.showNotification(`${t.user.name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`,"info"),this.websocket.readyState===WebSocket.OPEN&&this.websocket.send(JSON.stringify({type:"get_users"}));break;case"user_left":this.showSystemMessage(`${t.user.name} –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç`),this.showNotification(`${t.user.name} –≤—ã—à–µ–ª`,"info"),this.websocket.readyState===WebSocket.OPEN&&this.websocket.send(JSON.stringify({type:"get_users"}));break;case"error":this.showNotification(t.message,"error");break;case"system":this.showSystemMessage(t.message)}}catch(e){console.error("Error parsing WebSocket message:",e)}},this.websocket.onerror=e=>{console.error("WebSocket error:",e),this.updateConnectionStatus("error","–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"),this.disableMessageInput(),this.showNotification("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º","error")},this.websocket.onclose=e=>{if(console.log("WebSocket connection closed:",e.code,e.reason),this.stopHeartbeat(),this.autoReconnect&&!this.isExiting)if(this.reconnectionAttempts++,this.reconnectionAttempts<=this.maxReconnectionAttempts){const e=Math.min(2e3*this.reconnectionAttempts,1e4);this.updateConnectionStatus("reconnecting",`–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ... (${this.reconnectionAttempts}/${this.maxReconnectionAttempts})`),this.showNotification(`–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${e/1e3} —Å–µ–∫...`,"warning"),setTimeout((()=>{this.currentUser&&!this.isExiting&&(console.log(`Attempting to reconnect (${this.reconnectionAttempts}/${this.maxReconnectionAttempts})...`),this.connectWebSocket())}),e)}else this.updateConnectionStatus("disconnected","–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ"),this.disableMessageInput(),this.showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É","error");else this.updateConnectionStatus("disconnected","–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ"),this.disableMessageInput(),this.isExiting||this.showNotification("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø–æ—Ç–µ—Ä—è–Ω–æ","error")})}async onEnterChatHandler(e){if(this.isConnecting)return;const t=this.authModal.querySelector(".auth-input"),s=this.authModal.querySelector(".auth-button"),i=t.value.trim();if(i)if(i.length<2||i.length>20)this.showError("–ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 2 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤");else{this.isConnecting=!0,s.disabled=!0,s.textContent="–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...",s.classList.add("loading");try{localStorage.setItem("last_chat_username",i),localStorage.setItem("last_chat_session_time",Date.now().toString());const e=await this.api.create({name:i});"ok"===e.status?(this.currentUser=e.user,this.hideAuthModal(),this.showChat(),this.connectWebSocket(),this.showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${i}!`,"success")):this.showError(e.message||"–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏")}catch(e){if(e.message&&e.message.includes("This name is already taken!")||e.message&&e.message.includes("409"))if(this.showError("–≠—Ç–æ—Ç –Ω–∏–∫–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π."),confirm(`–ù–∏–∫–Ω–µ–π–º "${i}" —É–∂–µ –∑–∞–Ω—è—Ç. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –µ–≥–æ?`)){await this.autoCleanupAndRetry(i)||this.showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π.","error")}else this.showNotification("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –Ω–∏–∫–Ω–µ–π–º","info");else this.showError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ."),this.showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.","error");console.error("Registration error:",e)}finally{this.isConnecting=!1,s.disabled=!1,s.textContent="–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É",s.classList.remove("loading")}}else this.showError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º")}async autoCleanupAndRetry(e){console.log(`–ü—ã—Ç–∞–µ–º—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—Å—Ç–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º "${e}"...`),this.showNotification(`–û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –Ω–∏–∫–Ω–µ–π–º "${e}"...`,"info");try{if(await this.removeStuckUser(e)){await new Promise((e=>setTimeout(e,1e3))),this.showNotification("–ù–∏–∫–Ω–µ–π–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω. –ü—Ä–æ–±—É–µ–º –≤–æ–π—Ç–∏...","info");const t=await this.api.create({name:e});if("ok"===t.status)return this.currentUser=t.user,this.hideAuthModal(),this.showChat(),this.connectWebSocket(),this.showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${e}!`,"success"),!0}}catch(e){console.error("Auto-cleanup retry error:",e)}return!1}updateUserInfo(){const e=this.chatContainer.querySelector(".current-username");e&&this.currentUser&&(e.textContent=`${this.currentUser.name}`)}showError(e){const t=this.authModal.querySelector(".error-message");this.errorTimer&&(clearTimeout(this.errorTimer),this.errorTimer=null),t.textContent=e,t.style.display="flex",this.errorTimer=setTimeout((()=>{this.hideError()}),5e3)}hideError(){const e=this.authModal.querySelector(".error-message");e&&(e.style.display="none",e.textContent="",this.errorTimer&&(clearTimeout(this.errorTimer),this.errorTimer=null))}hideAuthModal(){this.authModal.classList.remove("active"),this.authModal.querySelector(".auth-input").value="",this.hideError();const e=this.authModal.querySelector(".auth-button");e.disabled=!1,e.textContent="–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É",e.classList.remove("loading"),this.isConnecting=!1}showAuthModal(){this.authModal.classList.add("active");const e=this.authModal.querySelector(".auth-button");e.textContent="–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É",e.disabled=!1,e.classList.remove("loading"),this.authModal.querySelector(".auth-input").focus(),this.hideError()}showChat(){this.chatContainer.classList.remove("hidden"),this.updateUserInfo()}connectWebSocket(){this.stopHeartbeat(),this.websocket&&(this.websocket.readyState!==WebSocket.CLOSED&&this.websocket.close(),this.websocket=null);window.location.protocol;const e="wss://sse-nq1x22rx8-dddarinas-projects.vercel.app";console.log(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket: ${e}`),this.websocket=new WebSocket(e),this.updateConnectionStatus("connecting","–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É..."),this.subscribeOnEvents()}updateConnectionStatus(e,t){const s=this.chatContainer.querySelector(".connection-status"),i=this.chatContainer.querySelector(".status-text");s&&("connected"===e?setTimeout((()=>{s.classList.add("hidden")}),3e3):s.classList.remove("hidden"),i.textContent=t,s.setAttribute("data-status",e))}enableMessageInput(){this.messageInput.disabled=!1,this.messageInput.placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",this.chatContainer.querySelector(".send-button").disabled=!1,this.messageInput.focus()}disableMessageInput(){this.messageInput.disabled=!0,this.messageInput.placeholder="–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ...",this.chatContainer.querySelector(".send-button").disabled=!0}updateUsersList(e){this.users=e;const t=this.chatContainer.querySelector(".users-list"),s=this.chatContainer.querySelector(".users-count");if(t.innerHTML="",s.textContent=e.length,0===e.length)return void(t.innerHTML='<li class="no-users">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç</li>');[...e].sort(((e,t)=>this.currentUser&&e.id===this.currentUser.id?-1:this.currentUser&&t.id===this.currentUser.id?1:e.name.localeCompare(t.name))).forEach((e=>{const s=document.createElement("li");s.className="chat__user",this.currentUser&&e.id===this.currentUser.id?(s.classList.add("current-user"),s.innerHTML=`\n          <div class="user-avatar-small">${e.name.charAt(0).toUpperCase()}</div>\n          <span class="user-name">${this.escapeHtml(e.name)}</span>\n          <span class="user-you"> (–í—ã)</span>\n        `):s.innerHTML=`\n          <div class="user-avatar-small">${e.name.charAt(0).toUpperCase()}</div>\n          <span class="user-name">${this.escapeHtml(e.name)}</span>\n        `,t.append(s)}))}sendMessage(){if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)return console.error("WebSocket is not connected. State:",this.websocket?this.websocket.readyState:"no websocket"),this.showSystemMessage("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º"),this.showNotification("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º","error"),void this.updateConnectionStatus("error","–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");const e=this.messageInput.value.trim();if(!e||!this.currentUser)return void(e||this.showNotification("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è","warning"));const t={type:"send",message:e,user:this.currentUser};try{this.websocket.send(JSON.stringify(t)),console.log("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:",t),this.messageInput.value="",this.messageInput.style.height="auto",this.messageInput.focus()}catch(e){console.error("Error sending message:",e),this.showNotification("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è","error")}}renderMessage(e){console.log("Rendering message:",e);const t=this.chatContainer.querySelector(".welcome-message");t&&(t.style.display="none"),this.messageHistory.push({...e,timestamp:new Date});const s=this.chatContainer.querySelector(".messages-list"),i=document.createElement("div"),n=this.currentUser&&e.user.id===this.currentUser.id,o=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});n?(i.className="message__container message__container-yourself",i.innerHTML=`\n        <div class="message__header" data-time="${o}">–í—ã</div>\n        <div class="message__body">${this.escapeHtml(e.message)}</div>\n      `):(i.className="message__container message__container-interlocutor",i.innerHTML=`\n        <div class="message__header" data-time="${o}">${this.escapeHtml(e.user.name)}</div>\n        <div class="message__body">${this.escapeHtml(e.message)}</div>\n      `),s.append(i);const a=this.chatContainer.querySelector(".chat__messages-container");a.scrollTop=a.scrollHeight}showSystemMessage(e){const t=this.chatContainer.querySelector(".messages-list"),s=document.createElement("div");s.className="message__container",s.style.textAlign="center",s.style.margin="10px 0",s.innerHTML=`\n      <div class="message__body system-message">${e}</div>\n    `,t.append(s);const i=this.chatContainer.querySelector(".chat__messages-container");i.scrollTop=i.scrollHeight}showExitConfirmation(){this.confirmModal.classList.add("active"),this.confirmModal.classList.remove("hidden")}hideExitConfirmation(){this.confirmModal.classList.remove("active"),setTimeout((()=>{this.confirmModal.classList.add("hidden")}),300)}exitOnUnload(){if(this.currentUser&&this.websocket&&this.websocket.readyState===WebSocket.OPEN)try{const e={type:"exit",user:this.currentUser};this.websocket.send(JSON.stringify(e))}catch(e){console.error("Error sending exit message on unload:",e)}this.currentUser&&localStorage.setItem("last_chat_session_time",Date.now().toString())}performExit(){if(this.hideExitConfirmation(),this.isExiting=!0,this.autoReconnect=!1,this.stopHeartbeat(),this.websocket&&this.websocket.readyState===WebSocket.OPEN){const e={type:"exit",user:this.currentUser};try{this.websocket.send(JSON.stringify(e))}catch(e){console.error("Error sending exit message:",e)}this.websocket.close()}this.showNotification("–í—ã –≤—ã—à–ª–∏ –∏–∑ —á–∞—Ç–∞","info"),this.resetChat(),setTimeout((()=>{this.showAuthModal()}),500)}resetChat(){this.notificationManager&&this.notificationManager.clearAll(),this.currentUser=null,this.users=[],this.stopHeartbeat(),this.websocket&&(this.websocket.readyState!==WebSocket.CLOSED&&this.websocket.close(),this.websocket=null),this.isExiting=!1,this.autoReconnect=!0,this.reconnectionAttempts=0,this.chatContainer.classList.add("hidden"),this.messageHistory=[],this.chatContainer.querySelector(".messages-list").innerHTML="",this.chatContainer.querySelector(".users-list").innerHTML='<li class="no-users">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç</li>',this.chatContainer.querySelector(".users-count").textContent="0";const e=this.chatContainer.querySelector(".welcome-message");e&&(e.style.display="block"),this.messageInput.value="",this.messageInput.disabled=!0,this.messageInput.placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",this.messageInput.style.height="auto",this.chatContainer.querySelector(".send-button").disabled=!0,this.errorTimer&&(clearTimeout(this.errorTimer),this.errorTimer=null)}showNotification(e,t="info"){this.notificationManager&&this.notificationManager.show(e,t)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}(n).init()})();